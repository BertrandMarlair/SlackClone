{"version":3,"sources":["../src/index.js"],"names":["app","httpServer","http","createServer","corsOptions","origin","credentials","use","endpointUrl","process","env","PORT","bodyParser","text","type","then","models","log","error","req","res","next","ApolloServer","schema","typeDefs","resolvers","context","user","SECRET","SECRET2","subscriptions","onConnect","connectionParams","token","refreshToken","applyMiddleware","path","sequelize","sync","force","endpoint","installSubscriptionHandlers","listen","info"],"mappings":"aAAA,wDACA,kDACA,kDACA,+DACA,sDACA,8DACA,8DACA,0DACA,2CAEA,gEACA,wFACA,yB,gfAEA,KAAMA,CAAAA,GAAG,CAAG,sBAAZ,CACA,KAAMC,CAAAA,UAAU,CAAGC,cAAKC,YAAL,CAAkBH,GAAlB,CAAnB,CAEA,GAAII,CAAAA,WAAW,CAAG,CACdC,MAAM,CAAE,GADM,CAEdC,WAAW,CAAE,IAFC,CAAlB,CAKAN,GAAG,CAACO,GAAJ,CAAQ,kBAAKH,WAAL,CAAR,EAEAJ,GAAG,CAACO,GAAJ,CACI,MADJ,CAEI,wBAAkB,CAACC,WAAW,CAAG,oBAAmBC,OAAO,CAACC,GAAR,CAAYC,IAAK,GAAnD,CAAlB,CAFJ,EAIAX,GAAG,CAACO,GAAJ,CAAQK,oBAAWC,IAAX,CAAgB,CAACC,IAAI,CAAE,qBAAP,CAAhB,CAAR,EAEA,qBAAYC,IAAZ,CAAiBC,MAAM,EAAI,CACvB,GAAI,CAACA,MAAL,CAAa,CACTC,gBAAIC,KAAJ,CAAU,6BAAV,EACA,MAAO,KAAP,CACH,CAEDlB,GAAG,CAACO,GAAJ,CAAQ,CAACY,GAAD,CAAMC,GAAN,CAAWC,IAAX,GAAoB,qBAAQF,GAAR,CAAaC,GAAb,CAAkBC,IAAlB,CAAwBL,MAAxB,CAA5B,EAEA,KAAMb,CAAAA,YAAY,CAAG,IACjB,GAAImB,kCAAJ,CAAiB,CACbC,MAAM,CAAE,uCAAqB,CACzBC,QAAQ,CAARA,eADyB,CAEzBC,SAAS,CAATA,gBAFyB,CAArB,CADK,CAMbC,OAAO,CAAE,CAAC,CAACP,GAAD,CAAD,IAAY,CACjBH,MADiB,CAEjBW,IAAI,CAAER,GAAG,EAAIA,GAAG,CAACQ,IAFA,CAGjBC,MAAM,CAAEnB,OAAO,CAACC,GAAR,CAAYkB,MAHH,CAIjBC,OAAO,CAAEpB,OAAO,CAACC,GAAR,CAAYmB,OAJJ,CAAZ,CANI,CAYbC,aAAa,CAAE,CACXC,SAAS,CAAEC,gBAAgB,EAAI,CAC3B,KAAM,CAACC,KAAD,CAAQC,YAAR,EAAwBF,gBAA9B,CAEA,GAAIC,KAAK,EAAIC,YAAb,CAA2B,CACvB,MAAO,iCAAoBD,KAApB,CAA2BC,YAA3B,CAAyClB,MAAzC,CAAP,CACH,CAED,MAAO,CAACA,MAAD,CAAP,CACH,CATU,CAZF,CAAjB,CADJ,CA6BAb,YAAY,CAAC,IAAD,CAAO,IAAP,CAAZ,CAAyBgC,eAAzB,CAAyC,CAACnC,GAAD,CAAMoC,IAAI,CAAE,UAAZ,CAAzC,EACApB,MAAM,CAACqB,SAAP,CAAiBC,IAAjB,CAAsB,CAACC,KAAK,CAAE,KAAR,CAAtB,EAAsCxB,IAAtC,CAA2C,IAAM,CAC7C,KAAMyB,CAAAA,QAAQ,CAAGrC,YAAY,EAA7B,CAEAqC,QAAQ,CAACC,2BAAT,CAAqCxC,UAArC,EACAuC,QAAQ,CAACL,eAAT,CAAyB,CAACnC,GAAD,CAAMoC,IAAI,CAAE,GAAZ,CAAzB,EAEAnC,UAAU,CAACyC,MAAX,CAAkBjC,OAAO,CAACC,GAAR,CAAYC,IAA9B,CAAoC,IAChCM,gBAAI0B,IAAJ,CACK,8CAA6ClC,OAAO,CAACC,GAAR,CAAYC,IAAK,GADnE,CADJ,EAKH,CAXD,EAYH,CAlDD","sourcesContent":["import express from \"express\";\nimport http from \"http\";\nimport cors from \"cors\";\nimport bodyParser from \"body-parser\";\nimport {express as voyagerMiddleware} from \"graphql-voyager/middleware\";\nimport getModels from \"./schema/index\";\nimport log from \"./utils/logger\";\nimport {ApolloServer} from \"apollo-server-express\";\nimport {makeExecutableSchema} from \"graphql-tools\";\nimport {typeDefs, resolvers} from \"./schema/index\";\nimport getUser from \"./utils/getUser\";\nimport getUserSubscription from \"./utils/getUserSubscription\";\nimport \"dotenv/config\";\n\nconst app = express();\nconst httpServer = http.createServer(app);\n\nlet corsOptions = {\n    origin: \"*\",\n    credentials: true,\n};\n\napp.use(cors(corsOptions));\n\napp.use(\n    \"/map\",\n    voyagerMiddleware({endpointUrl: `http://localhost:${process.env.PORT}/`}),\n);\napp.use(bodyParser.text({type: \"application/graphql\"}));\n\ngetModels().then(models => {\n    if (!models) {\n        log.error(\"Could not connect to server\");\n        return null;\n    }\n\n    app.use((req, res, next) => getUser(req, res, next, models));\n\n    const createServer = () =>\n        new ApolloServer({\n            schema: makeExecutableSchema({\n                typeDefs,\n                resolvers,\n                // schemaDirectives,\n            }),\n            context: ({req}) => ({\n                models,\n                user: req && req.user,\n                SECRET: process.env.SECRET,\n                SECRET2: process.env.SECRET2,\n            }),\n            subscriptions: {\n                onConnect: connectionParams => {\n                    const {token, refreshToken} = connectionParams;\n\n                    if (token && refreshToken) {\n                        return getUserSubscription(token, refreshToken, models);\n                    }\n\n                    return {models};\n                },\n                // onDisconnect: webSocket => {\n\n                // },\n            },\n        });\n\n    createServer(true, true).applyMiddleware({app, path: \"/explore\"});\n    models.sequelize.sync({force: false}).then(() => {\n        const endpoint = createServer();\n\n        endpoint.installSubscriptionHandlers(httpServer);\n        endpoint.applyMiddleware({app, path: \"/\"});\n\n        httpServer.listen(process.env.PORT, () =>\n            log.info(\n                `Server ready. -> start on http://localhost:${process.env.PORT}/`,\n            ),\n        );\n    });\n});\n"],"file":"index.js"}